/*!
 * EmberFire is the officially supported adapter for using Firebase with
 * Ember Data. The DS.FirebaseAdapter provides all of the standard DS.Adapter
 * methods and will automatically synchronize the store with Firebase.
 *
 * EmberFire 1.4.5
 * https://github.com/firebase/emberfire/
 * License: MIT
 */
(function(){"use strict";var e=window.Ember,r=window.DS,t=function(r,t,i,n){var o=i||[];return new e.RSVP.Promise(function(e,i){var a=function(r){r?(n&&"object"==typeof r&&(r.location=n),i(r)):e()};o.push(a),r.apply(t,o)})},i=e.String.fmt,n=e.RSVP.Promise,o=e.EnumerableUtils.forEach,a=e.EnumerableUtils.filter,s=e.EnumerableUtils.map,d=e.EnumerableUtils.indexOf,u=function(r){var t=e.A();return r.forEach(function(e){d(t,e)<0&&t.push(e)}),t},l=r.Adapter.extend(e.Evented,{defaultSerializer:"-firebase",init:function(){var e=this.get("firebase");if(!e||"object"!=typeof e)throw new Error("Please set the `firebase` property on the adapter.");this._ref=e.ref(),this._findAllMapForType={},this._recordCacheForType={},this._queue=[]},generateIdForRecord:function(){return this._getKey(this._ref.push())},_assignIdToPayload:function(e){var r=e.val();return null!==r&&"object"==typeof r&&"undefined"==typeof r.id&&(r.id=this._getKey(e)),r},find:function(e,r,t){var o=this,a=this._getRef(r,t);return new n(function(e,n){a.once("value",function(s){var d=o._assignIdToPayload(s);if(o._updateRecordCacheForType(r,d),null===d){var u=new Error(i("no record was found at %@",[a.toString()]));u.recordId=t,n(u)}else e(d)},function(e){n(e)})},i("DS: FirebaseAdapter#find %@ to %@",[r,a.toString()]))},recordWasPushed:function(e,r,t){t.__listening||this.listenForChanges(e,r,t)},recordWillUnload:function(e,r){var t=this._getRef(r.constructor,r.get("id"));t.off("value")},recordWillDelete:function(e,r){var t=this;r.eachRelationship(function(i,n){if("belongsTo"===n.kind){var o=r.get(n.key),a=r.inverseFor(n.key);if(a&&o.get("id")){var s=t._getRef(a.type,o.get("id"));t._removeHasManyRecord(e,s,a.name,r.id)}}})},listenForChanges:function(e,r,t){t.__listening=!0;var i=e.serializerFor(r),n=this,o=this._getRef(r,t.get("id")),a=!1;o.on("value",function(t){a&&n._handleChildValue(e,r,i,t),a=!0})},findMany:void 0,findAll:function(e,r){var t=this,o=this._getRef(r);return new n(function(i,n){o.once("value",function(n){t._findAllHasEventsForType(r)||t._findAllAddEventListeners(e,r,o);var a=[];n.forEach(function(e){var i=t._assignIdToPayload(e);t._updateRecordCacheForType(r,i),a.push(i)}),i(a)},function(e){n(e)})},i("DS: FirebaseAdapter#findAll %@ to %@",[r,o.toString()]))},findQuery:function(e,r,t){var o=this,a=this._getRef(r);return a=this.applyQueryToRef(a,t),new n(function(t,i){a.once("value",function(i){o._findAllHasEventsForType(r)||o._findAllAddEventListeners(e,r,a);var n=[];i.forEach(function(e){var t=o._assignIdToPayload(e);o._updateRecordCacheForType(r,t),n.push(t)}),t(n)},function(e){i(e)})},i("DS: FirebaseAdapter#findQuery %@ with %@",[r,t]))},applyQueryToRef:function(e,r){return r.orderBy||(r.orderBy="_key"),e="_key"===r.orderBy?e.orderByKey():"_value"===r.orderBy?e.orderByValue():"_priority"===r.orderBy?e.orderByPriority():e.orderByChild(r.orderBy),["limitToFirst","limitToLast","startAt","endAt","equalTo"].forEach(function(t){(r[t]||""===r[t])&&(e=e[t](r[t]))}),e},_findAllMapForType:void 0,_findAllHasEventsForType:function(r){return!e.isNone(this._findAllMapForType[r])},_findAllAddEventListeners:function(e,r,t){this._findAllMapForType[r]=!0;var i=this,n=e.serializerFor(r);t.on("child_added",function(t){e.hasRecordForId(r,i._getKey(t))||i._handleChildValue(e,r,n,t)})},_handleChildValue:function(e,r,t,i){if(!e.isDestroying){var n=i.val();if(null===n){var o=this._getKey(i),a=e.getById(r,o);a.get("isDeleted")||a.deleteRecord()}else{var s=this._assignIdToPayload(i);r.eachRelationship(function(e,r){"hasMany"!==r.kind||s[e]||(s[e]={})}),this._enqueue(function(){e.isDestroying||e.push(r,t.extractSingle(e,r,s))})}}},createRecord:function(e,r,t){var i=this,n=t.record||t;return this.updateRecord(e,r,t).then(function(){i.listenForChanges(e,r,n)})},updateRecord:function(r,t,o,a){var s=this,d=o.record||o,u=a||this._getRef(t,d.get("id")),l=s._getRecordCache(t.typeKey,d.get("id")),c=d.serialize({includeId:!1});return new n(function(n,o){var a=e.A();d.eachRelationship(function(e,i){var n;"hasMany"===i.kind?c[e]&&(n=s._saveHasManyRelationship(r,t,i,c[e],u,l),a.push(n),delete c[e]):i.options.embedded===!0&&c[e]&&(n=s._saveBelongsToRecord(r,t,i,c[e],u),a.push(n),delete c[e])});var h=e.RSVP.allSettled(a),f=s._updateRecord(u,c);e.RSVP.hashSettled({relationships:h,record:f}).then(function(r){var a=e.A(r.relationships.value).filterBy("state","rejected");if("rejected"===r.record.state&&a.push(r.record),0!==a.length){var s=new Error(i("Some errors were encountered while saving %@ %@",[t,d.id]));s.errors=a.mapBy("reason"),o(s)}else n()})},i("DS: FirebaseAdapter#updateRecord %@ to %@",[t,u.toString()]))},_updateRecord:function(e,r){return t(e.update,e,[r])},_saveHasManyRelationship:function(r,t,n,o,d,l){if(!e.isArray(o))throw new Error("hasMany relationships must must be an array");var c=this,h=e.A(l[n.key]),f=[],y=a(o,function(e){return!h.contains(e)});f=a(o,function(e){var t=n.type;return r.hasRecordForId(t,e)&&r.getById(t,e).get("isDirty")===!0}),f=s(u(f.concat(y)),function(e){return c._saveHasManyRecord(r,n,d,e)});var p=a(h,function(e){return!o.contains(e)});p=s(p,function(e){return c._removeHasManyRecord(r,d,n.key,e)});var v=f.concat(p);return e.RSVP.allSettled(v).then(function(r){var t=e.A(e.A(r).filterBy("state","rejected"));if(0===t.get("length"))return l[n.key]=o,r;var a=new Error(i("Some errors were encountered while saving a hasMany relationship %@ -> %@",[n.parentType,n.type]));throw a.errors=e.A(t).mapBy("reason"),a})},_saveHasManyRecord:function(e,r,i,n){var o=this._getRelationshipRef(i,r.key,n),a=e.getById(r.type,n),s=r.options.embedded===!0;return s?this.updateRecord(e,r.type,a,o):t(o.set,o,[!0])},_removeHasManyRecord:function(e,r,i,n){var o=this._getRelationshipRef(r,i,n);return t(o.remove,o,[],o.toString())},_saveBelongsToRecord:function(e,r,t,i,n){var o=n.child(t.key),a=e.getById(t.type,i);return this.updateRecord(e,t.type,a,o)},deleteRecord:function(e,r,i){var n=i.record||i,o=this._getRef(r,n.get("id"));return t(o.remove,o)},pathForType:function(r){var t=e.String.camelize(r);return e.String.pluralize(t)},_getRef:function(e,r){var t=this._ref,i=e;return e&&e.typeKey&&(i=e.typeKey),i&&(t=t.child(this.pathForType(i))),r&&(t=t.child(r)),t},_getRelationshipRef:function(e,r,t){return e.child(r).child(t)},_queueFlushDelay:1e3/60,_queueScheduleFlush:function(){e.run.later(this,this._queueFlush,this._queueFlushDelay)},_queueFlush:function(){o(this._queue,function(e){var r=e[0],t=e[1];r.apply(null,t)}),this._queue.length=0},_enqueue:function(e,r){if(this._queueFlushDelay){var t=this._queue.push([e,r]);1===t&&this._queueScheduleFlush()}else e.apply(null,r)},_recordCacheForType:void 0,_updateRecordCacheForType:function(r,t){if(t){var i=t.id,n=r.typeKey,o=this._getRecordCache(n,i);r.eachRelationship(function(r,i){if("hasMany"===i.kind){var n=t[r];o[r]=e.isNone(n)?e.A():e.A(e.keys(n))}})}},_getRecordCache:function(e,r){var t=this._recordCacheForType;return t[e]=t[e]||{},t[e][r]=t[e][r]||{},t[e][r]},_getKey:function(e){return"function"==typeof e.key?e.key():e.name()}}),c=e.EnumerableUtils.map,h=e.String.fmt,f=r.JSONSerializer.extend(e.Evented,{_normalizeNumberIDs:function(e,r){var t=[];e[r][0]===!0&&t.push("0"),e[r][1]===!0&&t.push("1"),e[r]=t},normalizeHasMany:function(r,t,i){var n=i.key;if("object"!=typeof t[n]||e.isArray(t[n])){if(e.isArray(t[n])&&t[n].length<3&&(t[n][0]===!0||t[n][1]===!0))this._normalizeNumberIDs(t,n);else if(e.isArray(t[n]))throw new Error(h('%@ relationship %@(\'%@\') must be a key/value map in Firebase. Example: { "%@": { "%@_id": true } }',[r.toString(),i.kind,i.type.typeKey,n,i.type.typeKey]))}else t[n]=e.keys(t[n])},normalizeEmbeddedHasMany:function(r,t,i){var n,o=i.key,a=t[o];if(t[o]){for(n in a){var s=a[n];null!==s&&"object"==typeof s&&(s.id=n),this.store.push(i.type,this.normalize(i.type,s))}t[o]=e.keys(t[o])}},normalizeEmbeddedBelongsTo:function(e,r,t){var i=t.key;if(r[i]){var n=r[i];if("string"!=typeof n.id)throw new Error(h('Embedded relationship "%@" of "%@" must contain an "id" property in the payload',[t.type.typeKey,e]));this.store.push(t.type,this.normalize(t.type,n)),r[i]=n.id}},normalizeBelongsTo:e.K,normalize:function(e,r){var t=this;return e.eachRelationship(function(i,n){"hasMany"===n.kind?n.options.embedded?t.normalizeEmbeddedHasMany(e,r,n):t.normalizeHasMany(e,r,n):n.options.embedded?t.normalizeEmbeddedBelongsTo(e,r,n):t.normalizeBelongsTo(e,r,n)}),this._super.apply(this,arguments)},extractSingle:function(e,r,t){return this.normalize(r,t)},extractArray:function(e,r,t){return c(t,function(t){return this.extractSingle(e,r,t)},this)},serializeHasMany:function(r,t,i){var n=r.record||r,o=i.key,a=this.keyForRelationship?this.keyForRelationship(o,"hasMany"):o;t[a]=e.A(n.get(o)).mapBy("id")},serializeBelongsTo:function(e,r,t){this._super(e,r,t);var i=t.key;("undefined"==typeof r[i]||""===r[i])&&delete r[i]}}),y=window.Firebase,p="1.4.5";e.libraries&&(y.SDK_VERSION&&e.libraries.registerCoreLibrary("Firebase",y.SDK_VERSION),e.libraries.registerCoreLibrary("EmberFire",p));var v={name:"emberfire",before:"ember-data",initialize:function(e,t){t.register("adapter:-firebase",l),t.register("serializer:-firebase",f),r.Store.prototype._emberfirePatched||r.Store.reopen({_emberfirePatched:!0,push:function(e,r,t){var i=this._super(e,r,t),n=this.adapterFor(i.constructor);return n.recordWasPushed&&n.recordWasPushed(this,e,i),i},recordWillUnload:function(e){var r=this.adapterFor(e.constructor);r.recordWillUnload&&r.recordWillUnload(this,e)},recordWillDelete:function(e){var r=this.adapterFor(e.constructor);r.recordWillDelete&&r.recordWillDelete(this,e)}}),r.Model.prototype._emberfirePatched||r.Model.reopen({_emberfirePatched:!0,unloadRecord:function(){return this.store.recordWillUnload(this),this._super()},deleteRecord:function(){this.store.recordWillDelete(this),this._super()}}),r.FirebaseAdapter=l,r.FirebaseSerializer=f}};window.DS.FirebaseAdapter=l,window.DS.FirebaseSerializer=f,e.onLoad("Ember.Application",function(e){e.initializer(v)})}).call(this);